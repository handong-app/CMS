<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Google OAuth Callback & Controls</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <h2>Google OAuth ì¸ì¦ ì²˜ë¦¬ ì¤‘...</h2>
    <pre id="output">ì²˜ë¦¬ ì¤‘...</pre>

    <!-- ìƒíƒœ í™•ì¸ ë²„íŠ¼ -->
    <button id="checkLoginBtn" style="margin-top: 10px">
      ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    </button>
    <pre id="loginCheckResult"></pre>

    <!-- ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
    <button id="logoutBtn" style="margin-top: 10px">ë¡œê·¸ì•„ì›ƒ</button>

    <!-- Access Token ì¬ë°œê¸‰ ë²„íŠ¼ -->
    <button id="refreshBtn" style="margin-top: 10px">
      Access Token ì¬ë°œê¸‰
    </button>

    <!-- ğŸš€ Refresh Token í‘œì‹œ, ë³µì‚¬, ë¶ˆëŸ¬ì˜¤ê¸° -->
    <div style="margin-top: 10px">
      <label for="refreshTokenInput"><b>Refresh Token:</b></label>
      <input
        id="refreshTokenInput"
        type="text"
        readonly
        style="width: 350px; margin-right: 8px"
      />
      <button id="loadRefreshTokenBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button id="copyRefreshTokenBtn">ë³µì‚¬</button>
    </div>

    <!-- í”„ë¡œí•„ ì¡°íšŒ ë²„íŠ¼ -->
    <button id="getProfileBtn" style="margin-top: 10px">í”„ë¡œí•„ ì¡°íšŒ</button>
    <pre id="profileResult"></pre>

    <!-- í”„ë¡œí•„ ìˆ˜ì • ë²„íŠ¼ -->
    <button id="updateProfileBtn" style="margin-top: 10px">
      í”„ë¡œí•„ ìˆ˜ì • (ì§€ì • ê°’ìœ¼ë¡œ)
    </button>

    <script>
      const baseUrl = "";
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");

      if (!code) {
        document.getElementById("output").textContent =
          "Authorization codeê°€ ì—†ìŠµë‹ˆë‹¤.";
      } else {
        $.ajax({
          url: baseUrl + "/api/auth/google",
          method: "GET",
          data: { code: code },
          success: function (resp) {
            localStorage.setItem("accessToken", resp.accessToken);
            localStorage.setItem("refreshToken", resp.refreshToken);
            document.getElementById("output").textContent =
              "ìƒˆ Access Token ë°œê¸‰ ì™„ë£Œ!";
          },
          error: function (xhr) {
            document.getElementById("output").textContent =
              "ë¡œê·¸ì¸ ì‹¤íŒ¨: " + (xhr.responseJSON?.error || xhr.statusText);
          },
        });
      }

      function parseJwt(token) {
        if (!token) return null;
        const base64Url = token.split(".")[1];
        if (!base64Url) return null;
        const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        try {
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split("")
              .map(function (c) {
                return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
              })
              .join("")
          );
          return JSON.parse(jsonPayload);
        } catch (e) {
          return null;
        }
      }

      $("#checkLoginBtn").click(function () {
        const token = localStorage.getItem("accessToken");
        if (!token) {
          $("#loginCheckResult").text(
            "AccessTokenì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
          );
          return;
        }
        $.ajax({
          url: baseUrl + "/api/auth/google/cb",
          method: "GET",
          headers: {
            Authorization: "Bearer " + token,
          },
          success: function (response) {
            $("#loginCheckResult").text(
              "ì„œë²„ ì‘ë‹µ: " + JSON.stringify(response, null, 2)
            );
          },
          error: function (xhr) {
            $("#loginCheckResult").text(
              "ì˜¤ë¥˜ ë°œìƒ: " + (xhr.responseJSON?.error || xhr.statusText)
            );
          },
        });
      });

      $("#logoutBtn").click(function () {
        const token = localStorage.getItem("accessToken");
        if (!token) {
          alert("accessTokenì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        $.ajax({
          url: baseUrl + "/api/auth/google/logout",
          method: "POST",
          headers: { Authorization: "Bearer " + token },
          success: function (resp) {
            localStorage.removeItem("accessToken");
            localStorage.removeItem("refreshToken");
            $("#output").text("ë¡œê·¸ì•„ì›ƒ ì„±ê³µ!");
          },
          error: function (xhr) {
            $("#output").text(
              "ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: " + (xhr.responseJSON?.error || xhr.statusText)
            );
          },
        });
      });

      $("#refreshBtn").click(function () {
        const refresh = localStorage.getItem("refreshToken");
        if (!refresh) {
          alert("refreshTokenì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        $.ajax({
          url: baseUrl + "/api/auth/google/refresh",
          method: "POST",
          headers: { "Refresh-Token": "Bearer " + refresh },
          success: function (resp) {
            localStorage.setItem("accessToken", resp.accessToken);
            $("#output").text("ìƒˆ Access Token ë°œê¸‰ ì™„ë£Œ!");
          },
          error: function (xhr) {
            $("#output").text(
              "ì¬ë°œê¸‰ ì‹¤íŒ¨: " + (xhr.responseJSON?.error || xhr.statusText)
            );
          },
        });
      });

      // ğŸš€ í”„ë¡œí•„ ì¡°íšŒ â†’ ìµœì‹  ìˆ˜ì •ë³¸
      $("#getProfileBtn").click(function () {
        const token = localStorage.getItem("accessToken");
        if (!token) {
          $("#profileResult").text(
            "AccessTokenì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ì‹œë„í•˜ì„¸ìš”."
          );
          return;
        }
        $.ajax({
          url: baseUrl + "/api/v1/user/profile",
          method: "GET",
          headers: {
            Authorization: "Bearer " + token,
          },
          success: function (resp) {
            $("#profileResult").text(JSON.stringify(resp, null, 2)); // ğŸš€ JSON.stringify ì ìš© ì™„ë£Œ
          },
          error: function (xhr) {
            $("#profileResult").text(
              "í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨: " + (xhr.responseJSON?.error || xhr.statusText)
            );
          },
        });
      });

      $("#updateProfileBtn").click(function () {
        const token = localStorage.getItem("accessToken");
        if (!token) {
          alert("AccessTokenì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ì‹œë„í•˜ì„¸ìš”.");
          return;
        }
        const payload = parseJwt(token);
        const userId = payload
          ? payload.sub?.replace(/^user-/, "") || payload.userId || null
          : null;
        if (!userId) {
          alert("í† í°ì—ì„œ ì‚¬ìš©ì IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const updateData = {
          userId: userId,
          name: "Alice",
          phone: "01012345678",
          studentId: "20231234",
          email: "alice@example.com",
          profileImage: "https://img.ai/alice.png",
        };
        console.log("Sending updateData:", updateData);

        $.ajax({
          url: baseUrl + "/api/v1/user/profile",
          method: "PATCH",
          headers: {
            Authorization: "Bearer " + token,
            "Content-Type": "application/json",
          },
          data: JSON.stringify(updateData),
          success: function () {
            alert("í”„ë¡œí•„ ìˆ˜ì • ì„±ê³µ!");
          },
          error: function (xhr) {
            alert(
              "í”„ë¡œí•„ ìˆ˜ì • ì‹¤íŒ¨: " + (xhr.responseJSON?.error || xhr.statusText)
            );
          },
        });
      });

      // ğŸš€ Refresh Token input ìë™ ë¡œë“œ ë° ë²„íŠ¼ ê¸°ëŠ¥
      function setRefreshTokenInput() {
        const refreshToken = localStorage.getItem("refreshToken") || "";
        $("#refreshTokenInput").val(refreshToken);
      }

      // í˜ì´ì§€ ë¡œë“œì‹œ ìë™ìœ¼ë¡œ inputì— í‘œì‹œ
      $(document).ready(function () {
        setRefreshTokenInput();
      });

      // ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ
      $("#loadRefreshTokenBtn").click(function () {
        setRefreshTokenInput();
        if (!$("#refreshTokenInput").val()) {
          alert("ì €ì¥ëœ Refresh Tokenì´ ì—†ìŠµë‹ˆë‹¤.");
        }
      });

      // input í´ë¦­ ì‹œ ì „ì²´ ì„ íƒ
      $("#refreshTokenInput").on("click", function () {
        $(this).select();
      });

      // ë³µì‚¬ ë²„íŠ¼ í´ë¦­ ì‹œ
      $("#copyRefreshTokenBtn").click(function () {
        const refreshToken = $("#refreshTokenInput").val();
        if (!refreshToken) {
          alert("ì €ì¥ëœ Refresh Tokenì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        navigator.clipboard
          .writeText(refreshToken)
          .then(() => {
            alert("Refresh Tokenì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
          })
          .catch((err) => {
            alert("ë³µì‚¬ ì‹¤íŒ¨: " + err);
          });
      });

      // refreshTokenì´ ê°±ì‹ ë  ë•Œ inputë„ ê°±ì‹ 
      function updateRefreshTokenInputIfChanged() {
        setRefreshTokenInput();
      }

      // Access Token ì¬ë°œê¸‰ ì‹œ refreshTokenì´ ê°±ì‹ ë  ìˆ˜ë„ ìˆìœ¼ë‹ˆ inputë„ ê°±ì‹ 
      $("#refreshBtn").click(function () {
        const refresh = localStorage.getItem("refreshToken");
        if (!refresh) {
          alert("refreshTokenì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        $.ajax({
          url: baseUrl + "/api/auth/google/refresh",
          method: "POST",
          headers: { "Refresh-Token": "Bearer " + refresh },
          success: function (resp) {
            localStorage.setItem("accessToken", resp.accessToken);
            $("#output").text("ìƒˆ Access Token ë°œê¸‰ ì™„ë£Œ!");
            updateRefreshTokenInputIfChanged();
          },
          error: function (xhr) {
            $("#output").text(
              "ì¬ë°œê¸‰ ì‹¤íŒ¨: " + (xhr.responseJSON?.error || xhr.statusText)
            );
          },
        });
      });
    </script>
  </body>
</html>
